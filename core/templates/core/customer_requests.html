{% extends 'core/base.html' %}
{% block title %}Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡{% endblock %}

{% block content %}
<div class="card shadow-sm p-4">
    <h3 class="mb-4 text-center text-primary">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>

    <!-- âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <form method="get" class="row mb-4">
        <div class="col-md-3">
            <input type="text" name="city" class="form-control" placeholder="ğŸ” Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" value="{{ selected_city }}">
        </div>
        <div class="col-md-3">
            <input type="text" name="district" class="form-control" placeholder="ğŸ˜ï¸ Ø§Ù„Ø­ÙŠ" value="{{ selected_district }}">
        </div>
        <div class="col-md-3">
            <select name="request_type" class="form-select">
                <option value="">ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</option>
                <option value="buy" {% if selected_type == "buy" %}selected{% endif %}>Ø´Ø±Ø§Ø¡</option>
                <option value="sell" {% if selected_type == "sell" %}selected{% endif %}>Ø¨ÙŠØ¹</option>
                <option value="rent" {% if selected_type == "rent" %}selected{% endif %}>Ø§Ø³ØªØ¦Ø¬Ø§Ø±</option>
                <option value="lease" {% if selected_type == "lease" %}selected{% endif %}>ØªØ£Ø¬ÙŠØ±</option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
        </div>
    </form>

    {% if requests %}
    <div class="table-responsive">
        <table class="table table-bordered table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</th>
                    <th>ğŸ“ Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th>ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                    <th>ğŸ˜ï¸ Ø§Ù„Ø­ÙŠ</th>
                    <th>ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>ğŸ  Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                    <th>ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰</th>
                    <th>âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø© / Ø¥Ø¬Ø±Ø§Ø¡</th>
                    <th>ğŸ‘ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                </tr>
            </thead>
            <tbody>
                {% for r in requests %}
                <tr class="{% if r.status == 'open' %}status-open{% elif r.status == 'reserved' %}status-reserved{% elif r.status == 'executed' %}status-executed{% endif %}">
                    <td>{{ r.full_name }}</td>
                    <td>{{ r.phone }}</td>
                    <td>{{ r.city }}</td>
                    <td>{{ r.district }}</td>
                    <td>{{ r.get_request_type_display }}</td>
                    <td>{{ r.get_property_type_display }}</td>
                    <td>{{ r.max_price|floatformat:0 }} Ø±ÙŠØ§Ù„</td>
                    <td>
                        {% if r.status == 'executed' %}
                            <span class="badge bg-success">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</span><br>
                            {% if r.execution %}
                                <small class="text-muted">Ø¨ÙˆØ§Ø³Ø·Ø©: {{ r.execution.agent.username }}</small>
                            {% endif %}

                        {% elif r.status == 'reserved' %}
                            <span class="badge bg-warning text-dark">â³ Ù…Ø­Ø¬ÙˆØ²</span><br>
                            <small class="text-muted">Ø¨ÙˆØ§Ø³Ø·Ø©: {{ r.reserved_by.username }}</small><br>

                            {% if r.reserved_by == request.user %}
                                <a href="{% url 'cancel_reservation' r.id %}" class="btn btn-sm btn-outline-danger mt-1 hover-btn">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²</a>
                            {% endif %}

                        {% else %}
                            <a href="{% url 'execute_request' r.id %}" class="btn btn-sm btn-outline-success hover-btn">ØªÙ†ÙÙŠØ°</a>
                            <a href="{% url 'reserve_request' r.id %}" class="btn btn-sm btn-outline-warning hover-btn">Ø­Ø¬Ø²</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if r.status == 'reserved' and r.reserved_by != request.user %}
                            <button class="btn btn-sm btn-outline-secondary" disabled>Ù…Ø­Ø¬ÙˆØ²</button>
                        {% else %}
                            <a href="{% url 'request_detail' r.id %}" class="btn btn-sm btn-outline-info hover-btn">Ø¹Ø±Ø¶</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªÙ†Ø·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„ÙÙ„Ø§ØªØ±.</p>
    {% endif %}
</div>
{% endblock %}
